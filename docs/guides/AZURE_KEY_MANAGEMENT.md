# Azure API 金鑰管理指南

## 🔍 如何在 Azure Portal 查看和管理 API 金鑰

### 步驟 1: 登入 Azure Portal

1. 前往 [Azure Portal](https://portal.azure.com/)
2. 使用您的 Azure 帳戶登入

### 步驟 2: 找到 Computer Vision 資源

有幾種方式可以找到您的資源：

#### 方法 A: 直接搜尋（最快）
1. 在 Azure Portal 頂部的搜尋欄中輸入您的資源名稱（例如：`receipt-ocr-vision`）
2. 點擊搜尋結果中的資源

#### 方法 B: 從資源群組查找
1. 在左側選單點擊「資源群組」
2. 找到包含您的 Computer Vision 資源的資源群組
3. 點擊資源群組名稱
4. 在資源列表中找到「Computer Vision」資源

#### 方法 C: 從所有資源查找
1. 在左側選單點擊「所有資源」
2. 在搜尋欄中輸入您的資源名稱
3. 在類型欄位篩選「Computer Vision」
4. 點擊您的資源

### 步驟 3: 查看金鑰和端點

1. 在資源的左側選單中，找到「資源管理」區塊
2. 點擊「金鑰和端點」（Keys and Endpoint）
3. 您會看到：
   - **KEY 1**：第一個 API 金鑰
   - **KEY 2**：第二個 API 金鑰（備用）
   - **端點**：API 端點 URL（格式：`https://your-resource-name.cognitiveservices.azure.com`）
   - **位置/區域**：資源所在的區域

### 步驟 4: 複製金鑰和端點

1. **複製端點 URL**：
   - 點擊端點旁邊的「複製」按鈕
   - 這是要填入 `.env` 檔案中 `AZURE_VISION_ENDPOINT` 的值
   - 格式應該類似：`https://your-resource-name.cognitiveservices.azure.com`
   - ⚠️ **重要**：不要包含尾隨斜線 `/`

2. **複製 API 金鑰**：
   - 點擊 KEY 1 或 KEY 2 旁邊的「複製」按鈕
   - 這是要填入 `.env` 檔案中 `AZURE_VISION_KEY` 的值
   - 建議使用 KEY 1，KEY 2 作為備用

### 步驟 5: 檢查資源狀態

在資源的「概覽」頁面，檢查：
- **狀態**：應該是「運行中」（Running）
- **定價層**：檢查是否為免費層（F0）或付費層（S1）
- **區域**：確認資源所在區域

### 步驟 6: 重新生成金鑰（如果需要）

如果懷疑金鑰洩露或需要重新生成：

1. 在「金鑰和端點」頁面
2. 點擊「重新產生 KEY 1」或「重新產生 KEY 2」
3. ⚠️ **注意**：重新生成會使舊金鑰立即失效
4. 記得更新 `.env` 檔案中的金鑰

### 步驟 7: 檢查配額和使用量

1. 在資源的左側選單中，點擊「配額和使用量」（Quota and Usage）
2. 查看：
   - **每月免費額度**：F0 層通常有 5,000 次免費交易
   - **已使用量**：查看當前使用情況
   - **剩餘額度**：確認是否還有可用額度

### 步驟 8: 檢查計費和成本

1. 在資源的左側選單中，點擊「成本分析」（Cost Management）
2. 查看：
   - **當月成本**：檢查是否有意外費用
   - **使用趨勢**：了解使用模式

## 🔧 更新 .env 檔案

拿到新的金鑰和端點後，更新 `.env` 檔案：

```env
# Azure Computer Vision API設定
# 注意：端點URL不要包含尾隨斜線（/）
AZURE_VISION_ENDPOINT=https://your-resource-name.cognitiveservices.azure.com
AZURE_VISION_KEY=your_new_key_here
```

## 🔍 忘記 Azure 帳號怎麼辦？

如果您忘記了使用哪個 Azure 帳號，可以嘗試以下方法：

### 方法 1: 檢查電子郵件記錄
1. 搜尋您的電子郵件，關鍵字：
   - "Azure"
   - "Microsoft Azure"
   - "Computer Vision"
   - "Cognitive Services"
2. 查看：
   - Azure 註冊確認信
   - 資源建立通知
   - 帳單或使用量報告

### 方法 2: 檢查瀏覽器記錄
1. 檢查瀏覽器的已儲存密碼：
   - Chrome: 設定 → 自動填入 → 密碼
   - Safari: 系統偏好設定 → 密碼
   - Firefox: 選項 → 隱私與安全 → 已儲存的登入資訊
2. 搜尋 "portal.azure.com" 查看相關帳號

### 方法 3: 嘗試所有可能的帳號
1. 前往 [Azure Portal](https://portal.azure.com/)
2. 點擊右上角的帳號圖示
3. 查看「切換目錄」選單，列出所有可用的帳號
4. 逐一檢查每個帳號是否有 Computer Vision 資源

**⚠️ 重要提示**：如果出現「選取的使用者帳戶不存在於租用戶中」錯誤，請參考下方「常見登入問題」章節。

### 方法 4: 從端點 URL 推測
如果您的 `.env` 檔案中有端點 URL，可以：
1. 端點格式：`https://your-resource-name.cognitiveservices.azure.com`
2. 資源名稱可能包含線索（例如：個人名稱、公司名稱等）
3. 在 Azure Portal 搜尋這個資源名稱

### 方法 5: 檢查訂閱記錄
1. 檢查信用卡或銀行帳單
2. 搜尋 "Microsoft" 或 "Azure" 的扣款記錄
3. 查看扣款帳號對應的電子郵件

### 方法 6: 使用 Azure CLI（如果已安裝）
```bash
# 列出所有已登入的帳號
az account list --output table

# 查看當前使用的帳號
az account show
```

### 方法 7: 檢查其他專案或筆記
- 檢查其他專案的 `.env` 檔案
- 查看筆記本或文件中的 Azure 帳號記錄
- 詢問團隊成員（如果是團隊專案）

### 方法 8: 重新建立資源（最後手段）
如果找不到原帳號，可以：
1. 使用任何可用的 Azure 帳號（或建立新帳號）
2. 建立新的 Computer Vision 資源
3. 取得新的金鑰和端點
4. 更新 `.env` 檔案

**注意**：重新建立資源會：
- 失去原有的使用量記錄
- 需要重新設定配額
- 可能影響計費（如果原資源有特殊優惠）

## 💰 Azure 免費層級說明

是的，Azure Computer Vision 提供免費層級（F0），這可能是您之前使用的方案。

### 免費層級（F0）限制

1. **免費額度**：
   - 每月 5,000 次交易免費
   - 適合個人或小規模使用

2. **功能限制**：
   - 支援所有基本 OCR 功能
   - 與付費層功能相同，只是有使用量限制

3. **速率限制**：
   - 每分鐘最多 20 次請求
   - 與付費層（S1）相同

4. **資源限制**：
   - 每個訂閱只能有一個免費層資源
   - 無法升級到更高層級

### 如何檢查是否為免費層

在 Azure Portal 中檢查：

1. 進入您的 Computer Vision 資源
2. 在左側選單點擊「概覽」或「定價層」
3. 查看「定價層」資訊：
   - **F0** = 免費層
   - **S1** = 標準層（付費）

### 免費層 vs 付費層（S1）

| 項目 | 免費層（F0） | 標準層（S1） |
|------|------------|------------|
| 每月免費額度 | 5,000 次 | 無 |
| 超過額度後 | 無法使用 | $1/1,000 次 |
| 速率限制 | 20 次/分鐘 | 20 次/分鐘 |
| 功能 | 完整功能 | 完整功能 |
| 每個訂閱限制 | 1 個資源 | 無限制 |

### 免費層使用建議

1. **監控使用量**：
   - 定期檢查「配額和使用量」頁面
   - 設定使用量警示（達到 80% 時提醒）

2. **優化使用**：
   - 避免重複處理相同圖片
   - 使用快取機制（本系統已實現）

3. **超出額度處理**：
   - 等到下個月初重置（免費額度每月重置）
   - 升級到 S1 付費層
   - 建立新的免費層資源（需要新訂閱）

### 如果免費額度用完了

1. **等待重置**：每月 1 日會重置免費額度
2. **升級到 S1**：在資源的「定價層」頁面升級
3. **建立新資源**：在新訂閱中建立新的免費層資源
4. **檢查其他訂閱**：可能在其他訂閱中有免費層資源

## 🚫 常見登入問題

### 問題：帳戶不存在於租用戶中

如果登入時出現以下錯誤：
```
選取的使用者帳戶不存在於租用戶 'Microsoft Services' 中，
因而無法存取該租用戶內的應用程式。
```

#### 原因
這通常是因為**帳戶類型不匹配**：
- **個人帳戶**（@outlook.com, @hotmail.com, @gmail.com 等）
- **工作/學校帳戶**（@company.com, @school.edu 等）
- Azure Portal 可能要求特定類型的帳戶

#### 解決方法

**方法 1: 使用個人 Microsoft 帳戶**
1. 清除瀏覽器的 Azure Portal Cookie
2. 前往 [Azure Portal](https://portal.azure.com/)
3. 選擇「使用個人 Microsoft 帳戶登入」
4. 使用 @outlook.com 或 @hotmail.com 帳戶

**方法 2: 使用工作/學校帳戶**
1. 清除瀏覽器的 Azure Portal Cookie
2. 前往 [Azure Portal](https://portal.azure.com/)
3. 選擇「使用工作或學校帳戶登入」
4. 使用公司或學校提供的帳戶

**方法 3: 登出所有帳戶後重新登入**
1. 在 Azure Portal 右上角點擊帳戶圖示
2. 點擊「登出」所有帳戶
3. 關閉瀏覽器
4. 重新開啟瀏覽器，前往 Azure Portal
5. 選擇正確的帳戶類型登入

**方法 4: 使用無痕/隱私模式**
1. 開啟瀏覽器的無痕模式（Chrome: Ctrl+Shift+N, Safari: Cmd+Shift+N）
2. 前往 [Azure Portal](https://portal.azure.com/)
3. 使用您認為正確的帳戶登入

**方法 5: 直接使用帳戶電子郵件登入**
1. 不要使用「快速登入」或已儲存的帳戶
2. 在登入頁面選擇「使用其他帳戶」
3. 手動輸入完整的電子郵件地址
4. 輸入密碼登入

### 問題：找不到您的資源

如果登入成功但找不到 Computer Vision 資源：

**檢查 1: 確認訂閱**
1. 在 Azure Portal 頂部搜尋欄輸入「訂閱」
2. 查看所有訂閱列表
3. 確認訂閱狀態為「有效」

**檢查 2: 搜尋資源**
1. 在頂部搜尋欄輸入資源名稱（例如：`receipt-ocr-vision`）
2. 或搜尋「Computer Vision」
3. 查看所有訂閱中的資源

**檢查 3: 切換目錄**
1. 點擊右上角帳戶圖示
2. 選擇「切換目錄」
3. 嘗試不同的目錄查看資源

### 問題：訂閱已過期或暫停

如果訂閱狀態顯示「已暫停」或「已過期」：

1. **檢查訂閱狀態**：
   - 前往「訂閱」頁面
   - 查看訂閱詳細資訊

2. **免費試用過期**：
   - Azure 免費試用有期限（通常 30 天或 12 個月）
   - 過期後需要升級到付費訂閱

3. **信用卡驗證**：
   - 某些訂閱需要有效的付款方式
   - 前往「付款方式」檢查設定

## ⚠️ 常見問題

### Q: 端點 URL 格式是什麼？
**A**: 正確格式：
- ✅ `https://your-resource-name.cognitiveservices.azure.com`
- ❌ `https://your-resource-name.cognitiveservices.azure.com/`（不要尾隨斜線）
- ❌ `https://your-resource-name.cognitiveservices.azure.com/vision/v3.2/read/analyze`（不要包含 API 路徑）

### Q: 金鑰過期了怎麼辦？
**A**: Azure API 金鑰不會自動過期，除非：
1. 手動重新生成
2. 資源被刪除
3. 訂閱被取消或暫停

如果無法使用，請檢查：
- 資源是否還在運行
- 訂閱是否有效
- 是否有網路連接問題

### Q: 如何確認資源是否正常？
**A**: 檢查以下項目：
1. 資源狀態為「運行中」
2. 訂閱狀態為「有效」
3. 配額未用盡（免費層每月 5,000 次）
4. 網路連接正常

### Q: 找不到資源怎麼辦？
**A**: 可能原因：
1. 資源已被刪除
2. 使用不同的 Azure 訂閱或帳戶
3. 資源名稱不同
4. 在錯誤的區域查找

解決方法：
- 檢查所有訂閱（點擊右上角帳戶圖示 → 切換目錄）
- 搜尋所有資源（不限定類型）
- 檢查資源群組

## 🔒 安全建議

1. **不要將金鑰提交到 Git**
   - 確保 `.env` 在 `.gitignore` 中
   - 使用 `env.example` 作為範本

2. **定期輪換金鑰**
   - 定期重新生成 API 金鑰
   - 使用 KEY 1 和 KEY 2 輪換使用

3. **限制資源訪問**
   - 使用 Azure 的網路規則限制訪問
   - 只在需要時開放資源

4. **監控使用量**
   - 設定使用量警示
   - 定期檢查成本分析

## 📊 檢查清單

完成以下檢查，確保 API 配置正確：

- [ ] 資源狀態為「運行中」
- [ ] 訂閱狀態為「有效」
- [ ] 已複製正確的端點 URL（不含尾隨斜線）
- [ ] 已複製正確的 API 金鑰
- [ ] `.env` 檔案已更新
- [ ] 端點 URL 格式正確（以 `https://` 開頭，包含 `.cognitiveservices.azure.com`）
- [ ] 配額未用盡
- [ ] 網路連接正常

## 🔗 相關連結

- [Azure Portal](https://portal.azure.com/)
- [Azure Computer Vision 文件](https://docs.microsoft.com/azure/cognitive-services/computer-vision/)
- [定價資訊](https://azure.microsoft.com/pricing/details/cognitive-services/computer-vision/)

---

**最後更新**: 2025-12-30

